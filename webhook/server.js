
// Servidor webhook para o chatbot harmonIA
const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');

// Configura√ß√£o do servidor
const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(bodyParser.json());
app.use(express.static('public'));

// Dados simulados para desenvolvimento
const audioSamples = [
  {
    id: "001",
    title: "M√∫sica Rom√¢ntica",
    style: "MPB",
    mood: "Rom√¢ntico",
    occasion: "Casamento",
    audio_url: "https://example.com/audio/musica-romantica.mp3"
  },
  {
    id: "002",
    title: "Celebra√ß√£o Familiar",
    style: "Pop",
    mood: "Alegria",
    occasion: "Anivers√°rio",
    audio_url: "https://example.com/audio/celebracao-familiar.mp3"
  }
];

// Rota para servir o widget do chatbot
app.get('/widget.js', (req, res) => {
  res.sendFile(__dirname + '/public/widget/chatbot.js');
});

// Endpoint principal para o webhook do Dialogflow
app.post('/webhook', (req, res) => {
  const intentName = req.body.queryResult?.intent?.displayName;
  const parameters = req.body.queryResult?.parameters;
  
  let response = {};
  
  // Processar diferentes intents
  switch(intentName) {
    case 'Default Welcome Intent':
      response = getWelcomeResponse();
      break;
      
    case 'Informa√ß√µes sobre Pacotes':
      response = getPackagesInfo();
      break;
      
    case 'Amostras de M√∫sicas':
      response = getMusicSamples(parameters?.style);
      break;
      
    case 'Calcular Pre√ßo':
      response = calculatePrice(parameters);
      break;
      
    case 'Iniciar Briefing':
      response = startBriefing(parameters);
      break;
      
    case 'Verificar Status':
      response = checkStatus(parameters);
      break;
      
    case 'Falar com Atendente':
      response = transferToHuman();
      break;
      
    default:
      response = getFallbackResponse();
  }
  
  res.json(response);
});

// Fun√ß√£o para mensagem de boas-vindas
function getWelcomeResponse() {
  return {
    fulfillmentText: "üëã Ol√°! Sou o assistente virtual da harmonIA. Posso ajudar voc√™ a conhecer nossos servi√ßos, enviar amostras, calcular pre√ßos ou iniciar seu briefing musical. Como posso te ajudar hoje?",
    fulfillmentMessages: [
      {
        text: {
          text: [
            "üëã Ol√°! Sou o assistente virtual da harmonIA. Posso ajudar voc√™ a conhecer nossos servi√ßos, enviar amostras, calcular pre√ßos ou iniciar seu briefing musical. Como posso te ajudar hoje?"
          ]
        }
      },
      {
        quickReplies: {
          title: "Como posso te ajudar hoje?",
          quickReplies: [
            "Conhecer pacotes",
            "Ouvir amostras",
            "Calcular pre√ßo",
            "Iniciar briefing"
          ]
        }
      }
    ]
  };
}

// Fun√ß√£o para informa√ß√µes sobre pacotes
function getPackagesInfo() {
  return {
    fulfillmentText: "Temos 3 pacotes principais: Essencial (R$219), Profissional (R$479), e Premium (R$969). Cada um oferece diferentes n√≠veis de servi√ßo.",
    fulfillmentMessages: [
      {
        text: {
          text: [
            `Temos 3 pacotes principais:

üéµ Pacote Essencial (R$219)
‚Ä¢ 1 composi√ß√£o musical com IA + revis√£o humana
‚Ä¢ 1 revis√£o gratuita
‚Ä¢ Entrega em at√© 48h
‚Ä¢ Ideal para: presentes emocionais

üéµ Pacote Profissional (R$479)
‚Ä¢ 3 varia√ß√µes em estilos diferentes
‚Ä¢ Masteriza√ß√£o b√°sica IA
‚Ä¢ Stems separados
‚Ä¢ 3 revis√µes gratuitas
‚Ä¢ Entrega em at√© 72h
‚Ä¢ Ideal para: criadores de conte√∫do

üéµ Pacote Premium (R$969)
‚Ä¢ 5 varia√ß√µes de composi√ß√£o
‚Ä¢ Masteriza√ß√£o profissional
‚Ä¢ Registro na Biblioteca Nacional
‚Ä¢ Partitura em formato MusicXML
‚Ä¢ Revis√µes ilimitadas (30 dias)
‚Ä¢ Ideal para: empresas e projetos corporativos`
          ]
        }
      },
      {
        quickReplies: {
          title: "Gostaria de saber mais detalhes sobre algum pacote espec√≠fico?",
          quickReplies: [
            "Detalhes Essencial",
            "Detalhes Profissional",
            "Detalhes Premium"
          ]
        }
      }
    ]
  };
}

// Fun√ß√£o para amostras de m√∫sicas
function getMusicSamples(style) {
  if (!style) {
    return {
      fulfillmentText: "Que tipo de m√∫sica voc√™ gostaria de ouvir?",
      fulfillmentMessages: [
        {
          text: {
            text: [
              "Claro! Temos v√°rias amostras de projetos anteriores. Que tipo de m√∫sica voc√™ gostaria de ouvir?"
            ]
          }
        },
        {
          quickReplies: {
            title: "Que tipo de m√∫sica voc√™ gostaria de ouvir?",
            quickReplies: [
              "Pop/Ac√∫stico",
              "Eletr√¥nico/Corporativo",
              "Orquestral/Coral",
              "Cl√°ssico/Rom√¢ntico"
            ]
          }
        }
      ]
    };
  }
  
  // L√≥gica para retornar amostra espec√≠fica
  return {
    fulfillmentText: `Aqui est√° uma amostra de ${style}. O que achou?`,
    fulfillmentMessages: [
      {
        text: {
          text: [
            `√ìtima escolha! Aqui est√° uma amostra de ${style}:

[Este seria um link para uma amostra real]

O que achou? Gostaria de ouvir outro estilo?`
          ]
        }
      },
      {
        quickReplies: {
          title: "O que gostaria de fazer agora?",
          quickReplies: [
            "Ouvir outro estilo",
            "Calcular pre√ßo",
            "Iniciar briefing"
          ]
        }
      }
    ]
  };
}

// Fun√ß√£o para c√°lculo de pre√ßo
function calculatePrice(parameters) {
  const package = parameters?.package;
  const extras = parameters?.extras || [];
  
  if (!package) {
    return {
      fulfillmentText: "Vamos calcular o pre√ßo do seu projeto musical!",
      fulfillmentMessages: [
        {
          text: {
            text: [
              "Vamos calcular o pre√ßo do seu projeto musical!\n\nPrimeiro, qual pacote b√°sico voc√™ tem interesse?"
            ]
          }
        },
        {
          quickReplies: {
            title: "Qual pacote b√°sico voc√™ tem interesse?",
            quickReplies: [
              "Pacote Essencial - R$219",
              "Pacote Profissional - R$479",
              "Pacote Premium - R$969"
            ]
          }
        }
      ]
    };
  }
  
  // L√≥gica para c√°lculo de pre√ßo com pacote e extras
  let basePrice = 0;
  switch(package) {
    case "Essencial":
      basePrice = 219;
      break;
    case "Profissional":
      basePrice = 479;
      break;
    case "Premium":
      basePrice = 969;
      break;
  }
  
  // Calcular extras
  let extrasTotal = 0;
  let extrasList = "";
  
  extras.forEach(extra => {
    let extraPrice = 0;
    switch(extra) {
      case "Revis√£o Extra":
        extraPrice = 99;
        break;
      case "Registro BN":
        extraPrice = 99;
        break;
      case "Registro UBC":
        extraPrice = 299;
        break;
      case "Masteriza√ß√£o Premium":
        extraPrice = 149;
        break;
      case "Stems":
        extraPrice = 99;
        break;
      case "Entrega Expressa":
        extraPrice = 199;
        break;
      case "Partituras":
        extraPrice = 149;
        break;
    }
    
    extrasTotal += extraPrice;
    extrasList += `‚Ä¢ ${extra} - R$${extraPrice}\n`;
  });
  
  const total = basePrice + extrasTotal;
  
  return {
    fulfillmentText: `Resumo do seu projeto: Pacote ${package} (R$${basePrice}) + Extras (R$${extrasTotal}) = Total R$${total}`,
    fulfillmentMessages: [
      {
        text: {
          text: [
            `Resumo do seu projeto:
‚Ä¢ Pacote ${package} - R$${basePrice}
${extrasList.length > 0 ? extrasList : "‚Ä¢ Sem extras adicionados\n"}
Total: R$${total}

Gostaria de prosseguir para o briefing ou tem mais alguma d√∫vida?`
          ]
        }
      },
      {
        quickReplies: {
          title: "O que gostaria de fazer agora?",
          quickReplies: [
            "Iniciar briefing",
            "Ouvir amostras",
            "Falar com atendente"
          ]
        }
      }
    ]
  };
}

// Fun√ß√£o para iniciar briefing
function startBriefing(parameters) {
  // Verificar em qual etapa do briefing o usu√°rio est√°
  const step = parameters?.briefing_step || "start";
  
  switch(step) {
    case "start":
      return {
        fulfillmentText: "Qual √© o seu nome completo?",
        fulfillmentMessages: [
          {
            text: {
              text: [
                "√ìtimo! Vou te guiar pelo processo de briefing.\n\nPara come√ßar, precisarei de algumas informa√ß√µes b√°sicas:\n\nQual √© o seu nome completo?"
              ]
            }
          }
        ]
      };
      
    case "name":
      return {
        fulfillmentText: "Qual √© o melhor e-mail para contato?",
        fulfillmentMessages: [
          {
            text: {
              text: [
                `Obrigado, ${parameters?.name || ""}! \n\nQual √© o melhor e-mail para contato?`
              ]
            }
          }
        ]
      };
      
    // Adicionar mais etapas do briefing conforme necess√°rio
      
    default:
      return {
        fulfillmentText: "Vamos iniciar seu briefing.",
        fulfillmentMessages: [
          {
            text: {
              text: [
                "√ìtimo! Vou te guiar pelo processo de briefing.\n\nPara come√ßar, precisarei de algumas informa√ß√µes b√°sicas:\n\nQual √© o seu nome completo?"
              ]
            }
          }
        ]
      };
  }
}

// Fun√ß√£o para verificar status
function checkStatus(parameters) {
  const email = parameters?.email;
  const orderId = parameters?.order_id;
  
  if (!email && !orderId) {
    return {
      fulfillmentText: "Para verificar o status do seu projeto, preciso do seu e-mail ou n√∫mero do pedido.",
      fulfillmentMessages: [
        {
          text: {
            text: [
              "Para verificar o status do seu projeto, preciso do seu e-mail ou n√∫mero do pedido. Qual voc√™ prefere informar?"
            ]
          }
        },
        {
          quickReplies: {
            title: "Como deseja verificar?",
            quickReplies: [
              "Verificar por e-mail",
              "Verificar por n√∫mero de pedido"
            ]
          }
        }
      ]
    };
  }
  
  // Simula√ß√£o de resposta - em produ√ß√£o, consultar banco de dados
  return {
    fulfillmentText: "Seu projeto est√° na fase de composi√ß√£o e tem previs√£o de entrega para 15/04/2025.",
    fulfillmentMessages: [
      {
        text: {
          text: [
            `Encontrei seu projeto!

üìä Status atual: Em fase de composi√ß√£o
üìÖ Data de in√≠cio: 10/04/2025
üéµ Pacote: Profissional
‚è±Ô∏è Previs√£o de entrega: 15/04/2025
‚úÖ Pr√≥ximas etapas: Composi√ß√£o > Revis√£o > Masteriza√ß√£o > Entrega

Gostaria de receber notifica√ß√µes sobre atualiza√ß√µes deste projeto?`
          ]
        }
      },
      {
        quickReplies: {
          title: "Gostaria de receber notifica√ß√µes?",
          quickReplies: [
            "Sim, ativar notifica√ß√µes",
            "N√£o, obrigado"
          ]
        }
      }
    ]
  };
}

// Fun√ß√£o para transferir para atendimento humano
function transferToHuman() {
  return {
    fulfillmentText: "Entendo que voc√™ prefere falar com um atendente. Como prefere ser contatado?",
    fulfillmentMessages: [
      {
        text: {
          text: [
            "Entendo que voc√™ prefere falar diretamente com um atendente.\n\nNosso hor√°rio de atendimento √© de segunda a sexta, das 9h √†s 18h.\n\nGostaria de:"
          ]
        }
      },
      {
        quickReplies: {
          title: "Como prefere ser contatado?",
          quickReplies: [
            "Contato via WhatsApp",
            "Contato via Email",
            "Continuar conversando"
          ]
        }
      }
    ]
  };
}

// Fun√ß√£o para respostas de fallback
function getFallbackResponse() {
  return {
    fulfillmentText: "Desculpe, n√£o consegui entender. Como posso ajudar?",
    fulfillmentMessages: [
      {
        text: {
          text: [
            "Desculpe, n√£o consegui entender completamente sua pergunta. Poderia reformular ou escolher uma das op√ß√µes abaixo?"
          ]
        }
      },
      {
        quickReplies: {
          title: "Como posso ajudar?",
          quickReplies: [
            "Informa√ß√µes sobre pacotes",
            "Ver amostras de m√∫sicas",
            "Calcular pre√ßo",
            "Iniciar briefing",
            "Falar com atendente"
          ]
        }
      }
    ]
  };
}

// Iniciar o servidor
app.listen(PORT, () => {
  console.log(`Servidor webhook para harmonIA rodando na porta ${PORT}`);
});
